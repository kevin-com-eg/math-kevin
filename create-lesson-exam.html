<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MathMaster - إنشاء درس وامتحان</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Tajawal', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e9eef5 100%);
    }
    
    /* بطاقة السؤال */
    .question-card {
      background: #f8fafc;
      border-right: 4px solid #3b82f6;
      transition: all 0.3s ease;
    }
    
    .question-card:hover {
      transform: translateX(-5px);
      box-shadow: 0 10px 20px -10px rgba(0,0,0,0.1);
    }
    
    /* كود الوصول */
    .code-box {
      background: linear-gradient(135deg, #667eea20, #764ba220);
      border: 2px dashed #667eea;
      font-family: 'Courier New', monospace;
    }
    
    /* زر الإضافة */
    .add-btn {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      transition: all 0.3s ease;
    }
    
    .add-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px -5px #22c55e80;
    }
    
    /* التبويبات */
    .tab {
      transition: all 0.3s ease;
    }
    
    .tab.active {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }
    
    /* تأثيرات */
    .focus-effect:focus {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px -5px rgba(67, 97, 238, 0.3);
      border-color: #667eea;
    }
  </style>
</head>
<body class="min-h-screen">

  <!-- شريط التنقل -->
  <div class="bg-white shadow-md sticky top-0 z-50">
    <div class="container mx-auto px-4">
      <div class="flex justify-between items-center h-16">
        
        <div class="flex items-center gap-3">
          <i class="fa-solid fa-calculator text-blue-600 text-2xl"></i>
          <h1 class="text-xl font-bold text-blue-700">MathMaster</h1>
          <span class="bg-green-100 text-green-700 text-xs px-3 py-1 rounded-full mr-4">إنشاء درس جديد</span>
        </div>
        
        <div class="flex items-center gap-4">
          <button onclick="window.location.href='teacher-dashboard.html'" 
                  class="border border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-50 transition">
            <i class="fa-regular fa-arrow-right ml-1"></i>
            رجوع
          </button>
        </div>
        
      </div>
    </div>
  </div>

  <!-- المحتوى الرئيسي -->
  <div class="container mx-auto px-4 py-8">
    
    <div class="max-w-4xl mx-auto">
      
      <!-- عنوان الصفحة -->
      <div class="text-center mb-8">
        <h2 class="text-3xl font-black text-gray-800 mb-2">إنشاء درس جديد</h2>
        <p class="text-gray-600">أضف فيديو الدرس وامتحان للطلاب</p>
      </div>
      
      <!-- التبويبات (اختياري) -->
      <div class="flex justify-center gap-2 mb-8">
        <button class="tab active px-6 py-2 rounded-full font-bold" onclick="switchTab('lesson')">
          <i class="fa-regular fa-book-open ml-1"></i>
          معلومات الدرس
        </button>
        <button class="tab px-6 py-2 rounded-full font-bold text-gray-600 hover:bg-gray-100" onclick="switchTab('exam')">
          <i class="fa-regular fa-pen-to-square ml-1"></i>
          أسئلة الامتحان
        </button>
      </div>
      
      <!-- ===== بطاقة إنشاء الدرس ===== -->
      <div id="lessonTab" class="bg-white rounded-3xl shadow-xl p-6 md:p-8 mb-6">
        
        <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
          <i class="fa-regular fa-circle-info text-blue-600"></i>
          معلومات الدرس
        </h3>
        
        <div class="space-y-5">
          
          <!-- عنوان الدرس -->
          <div>
            <label class="block font-bold text-gray-700 mb-2">
              <i class="fa-regular fa-heading ml-1 text-blue-600"></i>
              عنوان الدرس <span class="text-red-500">*</span>
            </label>
            <input type="text" id="lessonTitle" placeholder="مثال: شرح المعادلات الخطية - الدرس الأول"
                   class="focus-effect w-full p-4 border-2 border-gray-200 rounded-2xl focus:border-blue-500 focus:outline-none">
          </div>
          
          <!-- وصف الدرس -->
          <div>
            <label class="block font-bold text-gray-700 mb-2">
              <i class="fa-regular fa-paragraph ml-1 text-blue-600"></i>
              وصف الدرس (اختياري)
            </label>
            <textarea id="lessonDesc" rows="3" placeholder="وصف مختصر لمحتوى الدرس..."
                      class="focus-effect w-full p-4 border-2 border-gray-200 rounded-2xl focus:border-blue-500 focus:outline-none"></textarea>
          </div>
          
          <!-- الصف الدراسي -->
          <div>
            <label class="block font-bold text-gray-700 mb-2">
              <i class="fa-regular fa-graduation-cap ml-1 text-blue-600"></i>
              الصف الدراسي <span class="text-red-500">*</span>
            </label>
            <select id="lessonGrade" class="focus-effect w-full p-4 border-2 border-gray-200 rounded-2xl focus:border-blue-500 focus:outline-none">
              <option value="">-- اختر الصف --</option>
              <option value="1ث">الصف الأول الثانوي</option>
              <option value="2ث">الصف الثاني الثانوي</option>
              <option value="3ث">الصف الثالث الثانوي</option>
            </select>
          </div>
          
          <!-- رابط الفيديو -->
          <div>
            <label class="block font-bold text-gray-700 mb-2">
              <i class="fa-brands fa-youtube ml-1 text-red-600"></i>
              رابط الفيديو (YouTube) <span class="text-red-500">*</span>
            </label>
            <input type="url" id="videoUrl" placeholder="https://www.youtube.com/watch?v=..."
                   class="focus-effect w-full p-4 border-2 border-gray-200 rounded-2xl focus:border-blue-500 focus:outline-none">
            <p class="text-sm text-gray-500 mt-2">انسخ رابط الفيديو من YouTube</p>
          </div>
          
          <!-- كود الوصول (بيتولد تلقائي) -->
          <div>
            <label class="block font-bold text-gray-700 mb-2">
              <i class="fa-regular fa-key ml-1 text-yellow-600"></i>
              كود وصول الطلاب <span class="text-red-500">*</span>
            </label>
            <div class="flex gap-2">
              <input type="text" id="accessCode" readonly
                     class="code-box flex-1 p-4 rounded-2xl text-center font-mono font-bold text-xl text-blue-700">
              <button onclick="generateNewCode()" 
                      class="bg-gray-100 hover:bg-gray-200 px-6 rounded-2xl transition flex items-center gap-2">
                <i class="fa-regular fa-rotate"></i>
                توليد
              </button>
              <button onclick="copyCode()" 
                      class="bg-gray-100 hover:bg-gray-200 px-6 rounded-2xl transition flex items-center gap-2">
                <i class="fa-regular fa-copy"></i>
                نسخ
              </button>
            </div>
            <p class="text-sm text-gray-500 mt-2">هذا الكود سيدخله الطالب لفتح الدرس</p>
          </div>
          
        </div>
        
      </div>
      
      <!-- ===== قسم أسئلة الامتحان ===== -->
      <div id="examTab" class="bg-white rounded-3xl shadow-xl p-6 md:p-8">
        
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-bold flex items-center gap-2">
            <i class="fa-regular fa-pen-to-square text-green-600"></i>
            أسئلة الامتحان
          </h3>
          <button onclick="addQuestion()" 
                  class="add-btn text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2">
            <i class="fa-regular fa-plus"></i>
            إضافة سؤال
          </button>
        </div>
        
        <!-- رسالة لو مفيش أسئلة -->
        <div id="noQuestions" class="text-center py-12 border-2 border-dashed border-gray-300 rounded-3xl mb-4">
          <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fa-regular fa-file-lines text-gray-400 text-3xl"></i>
          </div>
          <h4 class="text-xl font-bold text-gray-700 mb-2">مفيش أسئلة حتى الآن</h4>
          <p class="text-gray-500 mb-4">أضف أول سؤال في الامتحان</p>
          <button onclick="addQuestion()" 
                  class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 transition">
            <i class="fa-regular fa-plus-circle ml-2"></i>
            أضف أول سؤال
          </button>
        </div>
        
        <!-- حاوية الأسئلة -->
        <div id="questionsContainer" class="space-y-4 mb-6">
          <!-- هنا هتتحط الأسئلة ديناميكياً -->
        </div>
        
        <!-- إعدادات الامتحان -->
        <div class="mt-8 pt-6 border-t-2 border-gray-200">
          <h4 class="font-bold mb-4">إعدادات الامتحان</h4>
          
          <div class="grid md:grid-cols-3 gap-4">
            
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">درجة النجاح</label>
              <select id="passScore" class="w-full p-3 border-2 border-gray-200 rounded-xl">
                <option>٥٠٪</option>
                <option>٦٠٪</option>
                <option selected>٧٠٪</option>
                <option>٨٠٪</option>
                <option>٩٠٪</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">الوقت المحدد</label>
              <select id="examTime" class="w-full p-3 border-2 border-gray-200 rounded-xl">
                <option>١٠ دقائق</option>
                <option>١٥ دقيقة</option>
                <option selected>٢٠ دقيقة</option>
                <option>٣٠ دقيقة</option>
                <option>٤٥ دقيقة</option>
                <option>٦٠ دقيقة</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">عدد المحاولات</label>
              <select id="examAttempts" class="w-full p-3 border-2 border-gray-200 rounded-xl">
                <option>محاولة واحدة</option>
                <option selected>محاولتين</option>
                <option>٣ محاولات</option>
                <option>غير محدود</option>
              </select>
            </div>
            
          </div>
        </div>
        
      </div>
      
      <!-- أزرار الحفظ -->
      <div class="flex gap-4 mt-8">
        <button onclick="saveLesson()" 
                class="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 rounded-2xl font-bold text-lg hover:from-blue-700 hover:to-purple-700 transition flex items-center justify-center gap-2">
          <i class="fa-regular fa-floppy-disk"></i>
          حفظ الدرس والامتحان
        </button>
        
        <button onclick="publishNow()" 
                class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 text-white p-4 rounded-2xl font-bold text-lg hover:from-green-700 hover:to-emerald-700 transition flex items-center justify-center gap-2">
          <i class="fa-regular fa-rocket"></i>
          نشر الآن
        </button>
      </div>
      
    </div>
  </div>

  <script>
    let questionCount = 0;
    
    // ===== توليد كود عشوائي =====
    function generateNewCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      const prefix = 'MATH';
      const year = new Date().getFullYear();
      
      let randomPart = '';
      for (let i = 0; i < 4; i++) {
        randomPart += chars[Math.floor(Math.random() * chars.length)];
      }
      
      const newCode = `${prefix}-${year}-${randomPart}`;
      document.getElementById('accessCode').value = newCode;
    }
    
    // ===== نسخ الكود =====
    function copyCode() {
      const code = document.getElementById('accessCode').value;
      navigator.clipboard.writeText(code).then(() => {
        alert('✅ تم نسخ الكود: ' + code);
      }).catch(() => {
        alert('❌ فشل النسخ');
      });
    }
    
    // ===== التبديل بين التبويبات =====
    function switchTab(tab) {
      const lessonTab = document.getElementById('lessonTab');
      const examTab = document.getElementById('examTab');
      const tabs = document.querySelectorAll('.tab');
      
      if (tab === 'lesson') {
        lessonTab.style.display = 'block';
        examTab.style.display = 'none';
        tabs[0].classList.add('active');
        tabs[1].classList.remove('active');
        tabs[1].classList.add('text-gray-600');
      } else {
        lessonTab.style.display = 'none';
        examTab.style.display = 'block';
        tabs[1].classList.add('active');
        tabs[0].classList.remove('active');
        tabs[0].classList.add('text-gray-600');
      }
    }
    
    // ===== إضافة سؤال جديد =====
    function addQuestion() {
      questionCount++;
      const container = document.getElementById('questionsContainer');
      const noQuestions = document.getElementById('noQuestions');
      const newQuestionId = `q${questionCount}`;
      
      // إخفاء رسالة "مفيش أسئلة"
      if (noQuestions) {
        noQuestions.style.display = 'none';
      }
      
      const questionHTML = `
        <div class="question-card bg-white p-6 rounded-xl relative" id="${newQuestionId}">
          
          <div class="flex justify-between items-start mb-4">
            <span class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">${questionCount}</span>
            <button onclick="removeQuestion('${newQuestionId}')" class="text-red-500 hover:text-red-700">
              <i class="fa-regular fa-trash-can text-xl"></i>
            </button>
          </div>
          
          <!-- نص السؤال -->
          <div class="mb-4">
            <label class="block text-sm font-bold text-gray-700 mb-2">نص السؤال</label>
            <input type="text" placeholder="اكتب السؤال هنا..." 
                   class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none">
          </div>
          
          <!-- الخيارات -->
          <div class="grid md:grid-cols-2 gap-3 mb-4">
            <div>
              <label class="block text-sm text-gray-600 mb-1">الخيار الأول (أ)</label>
              <input type="text" placeholder="..." 
                     class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none">
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">الخيار الثاني (ب)</label>
              <input type="text" placeholder="..." 
                     class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none">
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">الخيار الثالث (ج)</label>
              <input type="text" placeholder="..." 
                     class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none">
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">الخيار الرابع (د)</label>
              <input type="text" placeholder="..." 
                     class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none">
            </div>
          </div>
          
          <!-- الإجابة الصحيحة -->
          <div class="flex items-center gap-4">
            <label class="text-sm font-bold text-gray-700">الإجابة الصحيحة:</label>
            <select class="p-2 border-2 border-gray-200 rounded-lg">
              <option>الخيار الأول (أ)</option>
              <option>الخيار الثاني (ب)</option>
              <option>الخيار الثالث (ج)</option>
              <option>الخيار الرابع (د)</option>
            </select>
          </div>
          
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', questionHTML);
      
      // تمرير للصفحة للسؤال الجديد
      document.getElementById(newQuestionId).scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    // ===== حذف سؤال =====
    function removeQuestion(questionId) {
      if (confirm('هل أنت متأكد من حذف هذا السؤال؟')) {
        const element = document.getElementById(questionId);
        if (element) {
          element.remove();
          questionCount--;
          
          // إعادة ترقيم الأسئلة
          const questions = document.querySelectorAll('#questionsContainer .question-card');
          questions.forEach((q, index) => {
            q.querySelector('.bg-blue-600').textContent = index + 1;
          });
          
          // لو مفيش أسئلة، أرجع رسالة "مفيش أسئلة"
          if (questions.length === 0) {
            document.getElementById('noQuestions').style.display = 'block';
            questionCount = 0;
          }
        }
      }
    }
    
    // ===== حفظ الدرس =====
    function saveLesson() {
      // جمع بيانات الدرس
      const title = document.getElementById('lessonTitle').value;
      const grade = document.getElementById('lessonGrade').value;
      const videoUrl = document.getElementById('videoUrl').value;
      const code = document.getElementById('accessCode').value;
      
      // التحقق من الحقول المطلوبة
      if (!title || !grade || !videoUrl || !code) {
        alert('❌ من فضلك املأ جميع الحقول المطلوبة');
        return;
      }
      
      // جمع الأسئلة
      const questions = [];
      document.querySelectorAll('#questionsContainer .question-card').forEach((q, index) => {
        const inputs = q.querySelectorAll('input[type="text"]');
        const questionText = inputs[0]?.value;
        const options = [
          inputs[1]?.value,
          inputs[2]?.value,
          inputs[3]?.value,
          inputs[4]?.value
        ];
        const correctAnswer = q.querySelector('select')?.value;
        
        if (questionText && options.every(opt => opt)) {
          questions.push({
            number: index + 1,
            text: questionText,
            options: options,
            correctAnswer: correctAnswer
          });
        }
      });
      
      // التحقق من وجود أسئلة
      if (questions.length === 0) {
        alert('❌ من فضلك أضف على الأقل سؤال واحد في الامتحان');
        return;
      }
      
      // تجهيز البيانات كاملة
      const lessonData = {
        title: title,
        description: document.getElementById('lessonDesc').value,
        grade: grade,
        videoUrl: videoUrl,
        accessCode: code,
        createdAt: new Date().toISOString(),
        exam: {
          questions: questions,
          passScore: document.getElementById('passScore').value,
          timeLimit: document.getElementById('examTime').value,
          attempts: document.getElementById('examAttempts').value
        }
      };
      
      console.log('بيانات الدرس:', lessonData);
      
      // هنا هنضيف كود الحفظ في Firebase
      alert('✅ تم حفظ الدرس بنجاح!\nكود الوصول: ' + code);
      
      // العودة للوحة التحكم
      if (confirm('هل تريد العودة للوحة التحكم؟')) {
        window.location.href = 'teacher-dashboard.html';
      }
    }
    
    // ===== نشر فوري =====
    function publishNow() {
      saveLesson();
    }
    
    // ===== عند تحميل الصفحة =====
    window.onload = function() {
      generateNewCode();
      // إظهار تبويب الدرس أولاً
      document.getElementById('examTab').style.display = 'none';
    };
  </script>
  
</body>
</html>
